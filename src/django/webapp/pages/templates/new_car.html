{% extends 'base.html' %}

{% block title %}Add New Car{% endblock %}

{% block content %}
<style>
head, body{
    width: 95%; /* Make accordion fill the width */
      max-width: 85%; /* Prevent overflow beyond the screen width */
      overflow-x: hidden; /* Prevent horizontal scroll */
      box-sizing: border-box; /* Ensure padding doesn't cause overflow */
}
</style>
<div class="container mt-4">
    <h2 class="mb-3">Add Your Car</h2>
    
    <form id="newcar-form" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <label for="name" class="form-label">Car Name:</label>
            <input type="text" class="form-control" id="name" name="name" required>
        </div>

        <div class="mb-3">
            <label for="images" class="form-label">Upload Images:</label>
            <input type="file" class="form-control" id="images" name="images" multiple required>
        </div>

        <button type="submit" class="btn btn-primary">Add Car</button>
    </form>

    <div id="response-message" class="alert mt-3" style="display: none;"></div>
</div>

<script>
    document.getElementById('newcar-form').onsubmit = async function(event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('name', document.getElementById('name').value);
        const images = document.getElementById('images').files;
        for (const image of images) {
            formData.append('images', image);
        }

        const token = localStorage.getItem('id_token');
        if (!token) {
            alert("You must be logged in to add a new car.");
            return;
        }

        try {
            const response = await fetch('/add-car/', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': `Bearer ${token}`,
                }
            });

            const result = await response.json();
            let messageDiv = document.getElementById("response-message");
            messageDiv.style.display = 'block';
            
            if (response.ok) {
                messageDiv.className = "alert alert-success";
                messageDiv.innerText = "Successfully added car and images!";
            } else {
                messageDiv.className = "alert alert-danger";
                if (result.message) {
                    messageDiv.innerText = result.message;
                } else if (result.detail) { 
                    // Handle generic DRF error messages
                    messageDiv.innerText = result.detail;
                } else {
                    messageDiv.innerText = "Failed to add car. Please try again.";
                }
                // messageDiv.innerText = result.error || "Failed to add car.";
            }
        } catch (error) {
            console.error("Error:", error);
        }
    };
</script>
{% endblock %}
