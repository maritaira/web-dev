{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<style>
  .container-fluid {
      height: 100vh;
      padding: 0;
  }
  html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
  }
  .accordion-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 100vh;
      overflow-y: auto;
      padding-top: 60px;
      background-color: #fff;
      z-index: 999;
  }
  .accordion {
      width: 90%;
      max-width: 90%;
      overflow-x: hidden;
      box-sizing: border-box;
  }
  .accordion-item {
      width: 100%;
      margin-bottom: 10px;
      border: none;
  }
  .accordion-button {
      width: 100%;
      text-align: left;
  }
  .accordion-body {
      max-height: 500px;
      overflow-y: auto;
  }
  .img-fluid {
      max-width: 20%;
      height: auto;
  }
  .button-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      gap: 15px;
  }
  .button-group button {
      flex: 1;
      min-width: 60px;
      padding: 5px 10px;
      font-size: 0.875rem;
  }
  .join-race-group {
      display: flex;
      align-items: center;
      gap: 10px;
  }
  .join-race-group input {
      width: 170px;
  }
  .add-car-group {
      display: flex;
      align-items: center;
      gap: 10px;
  }

  @media (max-width: 200px) {
      .accordion-button {
          font-size: 15px;
      }
      .accordion-body {
          max-height: 150px;
      }
  }
</style>

<div class="container">
    <h2 class="mt-3">Hello {{ username }}!</h2>
    <h4 class="text-muted">My Cars</h4>

    <div class="accordion mt-3" id="carAccordion">
      {% for car in cars %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading-{{ car.id }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ car.id }}" aria-expanded="false" aria-controls="collapse-{{ car.id }}">
              {{ car.name }}
            </button>
          </h2>
          <div id="collapse-{{ car.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ car.id }}" data-bs-parent="#carAccordion">
            <div class="accordion-body">
              {% if car_images|get_item:car.name %}
                {% with car_images|get_item:car.name as car_image_list %}
                  <div class="d-flex flex-wrap">
                    {% for image_url in car_image_list %}
                      <img src="{{ image_url }}" alt="{{ car.name }} Image" class="img-fluid mb-2 me-2" />
                    {% endfor %}
                  </div>

                  <hr>
                  <div class="button-group">
                    <div class="add-car-group">
                      <input type="file" class="form-control" id="images" name="images" multiple required>
                      <button class="btn btn-primary" >Add Car</button>
                    </div>
                    {% if car_image_list|length >= 1 %}
                      <div class="join-race-group">
                        <input type="text" class="form-control join-code" placeholder="Join Code">
                        <button class="btn btn-success join-race-btn" data-car-id="{{ car.id }}">Join Race</button>
                      </div>
                    {% endif %}
                    <button class="btn btn-danger">Delete Car</button>
                  </div>
                {% endwith %}
              {% else %}
                <p>No images available for this car.</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const joinRaceButtons = document.querySelectorAll('.join-race-btn');

    joinRaceButtons.forEach(button => {
      button.addEventListener('click', function (e) {
        e.preventDefault();

        const carId = this.getAttribute('data-car-id');
        const joinCodeInput = this.parentElement.querySelector('.join-code');
        const joinCode = joinCodeInput.value;

        if (!joinCode) {
          alert("Please enter a join code.");
          return;
        }

        console.log("Sending car_id", carId);
        console.log("Sending join_code", joinCode)

        // get the id token from local storage
        const idToken = localStorage.getItem("id_token");

        if (!idToken) {
            alert("You must be logged in to create a race.");
            return;
        }

        fetch('/join-race/', {
          method: 'POST',
          headers: {
            "Authorization": "Bearer " + idToken,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            'car_id': carId,
            'join_code': joinCode
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Joined race successfully!');
          } else {
            alert(data.error || 'Failed to join the race.');
          }
        })
        .catch(err => console.error('Error:', err));
      });
    });
  });
</script>
{% endblock %}