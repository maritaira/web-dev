{% extends 'raceowner_base.html' %}

{% block title %}All Races - My App{% endblock %}

{% block content %}

<style>
  .container-fluid {
      height: 100vh; /* Full height of the viewport */
      padding: 0;
  }
  html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Prevent any scrolling */
    }
form{
    width: 90%; /* Make accordion fill the width */
      max-width: 80%; /* Prevent overflow beyond the screen width */
      overflow-x: hidden; /* Prevent horizontal scroll */
      box-sizing: border-box; /* Ensure padding doesn't cause overflow */
}
table{
    width: 90%; /* Make accordion fill the width */
    max-width: 90%; /* Prevent overflow beyond the screen width */
    overflow-x: hidden; /* Prevent horizontal scroll */
    box-sizing: border-box; /* Ensure padding doesn't cause overflow */
}

</style>
<div class="container mt-4">
    <h1 class="mb-3">All Races</h1>

    <!-- Search Form -->
    <form id="search-form" class="mb-4">
        <div class="input-group">
            <input type="text" id="search-race" class="form-control" placeholder="Search by Race Name..." required>
            <button class="btn btn-primary" type="submit">Search</button>
        </div>
    </form>

    <!-- Table to Display Races -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Race Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="race-table-body">
            <!-- Data will be inserted here -->
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    syncVideos();   // Sync videos when page loads
    fetchVideos();  // Load races on page load

    // Sync Videos based on user group
    function syncVideos() {
        const idToken = localStorage.getItem("id_token");

        if (!idToken) {
            alert("You must be logged in to create a race.");
            return;
        }
        
        const userGroup = "raceowner"
        console.log("Sending data:", userGroup);
        
        fetch('/media/videos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": "Bearer " + idToken,
            },
            body: JSON.stringify({ 'user_group': userGroup })
        })
        .then(response => response.json())
        .then(data => console.log('Sync completed:', data))
        .catch(error => console.error('Error syncing videos:', error));
    }

    // Fetch all race videos from media
    function fetchVideos(query = '') {
        const idToken = localStorage.getItem("id_token");

        if (!idToken) {
            alert("You must be logged in to create a race.");
            return;
        }
        
        const userGroup = "raceowner"
        console.log("FV Sending data:", userGroup);
        
        fetch(`/media/videos/?group=${userGroup}&race=${query}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": "Bearer " + idToken,
            },
        })  // Update this line to fetch from media/videos endpoint
        .then(response => response.json())
        .then(data => {
            let tableBody = document.getElementById("race-table-body");
            tableBody.innerHTML = ""; // Clear previous entries

            data.forEach(video => {
                let row = `<tr>
                    <td>${video.race}</td>
                    <td><a href="/pages/play_video/?race=${video.race_id}&next=raceowner_videos" class="btn btn-primary btn-sm">Watch</a></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        })
        .catch(error => console.error("Error fetching videos:", error));
    }

    // Handle search functionality (AJAX-style)
    document.getElementById("search-form").addEventListener("submit", function(event) {
        event.preventDefault();
        let raceName = document.getElementById("search-race").value.trim();
        fetchVideos(raceName);  // Refetch with query
    });
});
</script>
    
{% endblock %}
