{% extends 'raceowner_base.html' %}

{% block title %}Race Owner Dashboard{% endblock %}

{% block content %}
<style>
    .accordion {
        width: 90%; /* Makes it responsive */
        margin: 0; /* Centers it */
    }
    .accordion-button {
        font-weight: bold;
    }
    .accordion .table-wrapper {
        overflow-x: auto; /* Enables horizontal scrolling */
        max-width: 100%; /* Prevents overflow */
    }
    
    .accordion table {
        width: 100%; /* Ensures table scales properly */
        table-layout: auto;
    }
    .car-checklist-item {
        display: block;
        margin-bottom: 6px; /* Optional spacing between items */
    }
</style>
<div class="container">
    <h2>Welcome to Your Race Track Owner Dashboard</h2>
    <p>From here, you can manage your races and videos.</p>

    <!-- Create Race Button -->
    <a href="{% url 'pages:create_race' %}" class="btn btn-primary btn-lg mt-4">
        <i class="bi bi-plus-circle"></i> Create New Race
    </a>

    <!-- List of Races (Placeholder for now) -->
    <div id="raceAccordion" class="accordion mt-4">
        <!-- The list of races will be dynamically populated here -->
    </div>
</div>

<script>
    async function fetchEligibleCarsForRace(raceId) {
        const idToken = localStorage.getItem("id_token");
        if (!idToken) {
            alert("You must be logged in to view eligible cars.");
            return [];
        }
    
        try {
            const response = await fetch(`/eligible-cars/?race_id=${raceId}`, {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + idToken,
                    "Content-Type": "application/json"
                }
            });
    
            if (!response.ok) throw new Error("Failed to fetch eligible cars.");
            const data = await response.json();
            console.log("Response: ", data)
            return data || [];
        } catch (error) {
            console.error(`Error fetching eligible cars for race ${raceId}:`, error);
            return [];
        }
    }

    function renderChecklistForRace(raceId, cars) {
        const checklistContainer = document.getElementById(`car-checklist-${raceId}`);

        if (!checklistContainer) {
            console.warn(`Element with ID "car-checklist-${raceId}" not found.`);
            return;
        }

        checklistContainer.innerHTML = "";
    
        cars.forEach(car => {
            const wrapper = document.createElement("label");
            wrapper.className = "car-checklist-item";
    
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = `selected_cars_${raceId}`;
            checkbox.value = car.id;
            checkbox.style.marginRight = "8px";
    
            const nameSpan = document.createElement("span");
            nameSpan.innerHTML = `<strong>${car.name}</strong> (${car.owner_username})`;
    
            wrapper.appendChild(checkbox);
            wrapper.appendChild(nameSpan);
            checklistContainer.appendChild(wrapper);
        });

        // Add change handler to enforce max selections
        checklistContainer.addEventListener("change", function (e) {
            if (e.target.name === `selected_cars_${raceId}`) {
                const max = parseInt(document.getElementById(`max-cars-${raceId}`).textContent, 10);
                const current = parseInt(document.getElementById(`cur-cars-${raceId}`).textContent, 10);
                const checkboxes = checklistContainer.querySelectorAll(`input[name="selected_cars_${raceId}"]`);
                const selected = checklistContainer.querySelectorAll(`input[name="selected_cars_${raceId}"]:checked`);

                if (selected.length + current > max) {
                    e.target.checked = false;
                    alert(`You can only select up to ${max} cars.`);
                }

                checkboxes.forEach(cb => cb.disabled = (selected.length + current) >= max && !cb.checked);
            }
        });
    }

    async function submitParticipants(raceId) {
        const idToken = localStorage.getItem("id_token");
        if (!idToken) {
            alert("You must be logged in add cars to your race.");
            return [];
        }
        const selectedCheckboxes = document.querySelectorAll(`input[name="selected_cars_${raceId}"]:checked`);
        console.log("selected num: ", selectedCheckboxes.length)
        const selectedCarIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        console.log("Selected cars: ", selectedCarIds)
    
        try {
            const response = await fetch("/add-participants/", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + idToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    race_id: raceId,
                    car_ids: selectedCarIds
                })
            });
    
            if (!response.ok) throw new Error("Failed to add participants.");
            alert("Participants successfully added!");
            window.location.reload();
        } catch (error) {
            console.error("Error adding participants:", error);
            alert("Failed to add participants.");
        }
    }

    // Check if the user is authenticated by verifying the idToken
    document.addEventListener("DOMContentLoaded", async function() {
        // Retrieve the idToken from localStorage
        const idToken = localStorage.getItem("id_token");

        if (!idToken) {
            alert("You must be logged in to access the Race Owner Dashboard.");
            window.location.href = "/login/";  // Redirect to login page
            return;
        }

        // Fetch race data with the authorization token
        try {
            const response = await fetch("/races/my_races/", {
                method: "GET",
                headers: {
                    "Authorization": "Bearer " + idToken,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error("Unauthorized or failed to fetch races.");
            }

            const data = await response.json();
            console.log("Races Data:", data);


            const raceAccordion = document.getElementById("raceAccordion");
            raceAccordion.innerHTML = ''; // Clear previous content

            if (data && Object.keys(data).length > 0) {
                Object.keys(data).forEach(async (raceName, index) => {
                    const raceDetails = data[raceName].details;
                    const cars = data[raceName].cars;

                    // Create accordion item
                    const accordionItem = document.createElement("div");
                    accordionItem.classList.add("accordion-item");

                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#collapse${index}" 
                                aria-expanded="${index === 0}" aria-controls="collapse${index}">
                                ${raceName}
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                            aria-labelledby="heading${index}">
                            <div class="accordion-body">
                                <p><strong>Location:</strong> ${raceDetails.location}</p>
                                <p><strong>Date:</strong> ${raceDetails.date}</p>
                                <p><strong>Total Number of Cars:</strong> ${raceDetails.num_cars}</p>
                                <span id="max-cars-${raceDetails.id}" style="display:none">${raceDetails.num_cars}</span>
                                <span id="cur-cars-${raceDetails.id}" style="display:none">${cars.length}</span>

                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">Car</th>
                                            <th scope="col">Owner</th>
                                            <th scope="col">Username</th>
                                            <th scope="col">Email</th>
                                            <th scope="col"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="raceTableBody${index}">
                                        ${cars.length > 0 ? cars.map(carAndOwner => `
                                            <tr>
                                                <td>${carAndOwner.car}</td>
                                                <td>${carAndOwner.firstname} ${carAndOwner.lastname}</td>
                                                <td>${carAndOwner.owner}</td>
                                                <td>${carAndOwner.email}</td>
                                                <td class="text-end">
                                                    <button class="btn btn-danger btn-sm" onclick="removeCarFromRace('${raceDetails.id}', '${carAndOwner.id}', '${raceName}', '${carAndOwner.car}')">
                                                        Remove
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('') : `<tr><td colspan="4">No cars in this race.</td></tr>`}
                                    </tbody>
                                </table>

                                ${cars.length < raceDetails.num_cars ? `
                                    <div class="add-cars-section mt-3">
                                        <label for="car-checklist-${raceDetails.id}"><strong>Select cars to add:</strong></label>
                                        <div id="car-checklist-${raceDetails.id}" class="form-select" multiple>
                                            <!-- Options will be populated via JS -->
                                        </div>
                                        <button class="btn btn-primary mt-2" onclick="submitParticipants('${raceDetails.id}')">
                                            Add Cars
                                        </button>
                                    </div>
                                ` : ''}

                                <!-- Start Training Button (Only visible if number of cars matches num_cars) -->
                                <div class="btn-container">
                                    <button class="btn btn-success btn-lg" 
                                        id="startTrainingBtn${index}" 
                                        style="display: ${cars.length === raceDetails.num_cars ? 'block' : 'none'}"
                                        onclick="startTraining(${raceDetails.id}, '${raceName}', ${raceDetails.num_cars}, '${cars.map(car => car.car).join(',')}')">
                                        Start Training
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    raceAccordion.appendChild(accordionItem);
                    
                    if (cars.length < raceDetails.num_cars) {
                        const eligible = await fetchEligibleCarsForRace(raceDetails.id);
                        renderChecklistForRace(raceDetails.id, eligible);
                    }
                });
            } else {
                raceAccordion.innerHTML = "<p>No races found.</p>";
            }

        } catch (error) {
            console.error("Error fetching races:", error);
            alert("Failed to fetch races. Please try again later.");
        }
    });

    // Function to handle car removal
    async function removeCarFromRace(raceId, carId, raceName, carName) {
        // Retrieve the idToken from localStorage
        const idToken = localStorage.getItem("id_token");
    
        if (!idToken) {
            alert("You must be logged in to remove a car.");
            window.location.href = "/login/";  // Redirect to login page
            return;
        }
        
        const confirmRemoval = confirm(`Are you sure you want to remove ${carName} from ${raceName}?`);
        if (!confirmRemoval) return;

        try {
            const response = await fetch("/races/remove-car/", {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + idToken,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ race_id: raceId, car_id: carId })  // Sending IDs in the request body
            });
    
            if (response.status === 204) {
                console.log("Success: Car successfully removed");
                window.location.reload();  // Refresh the page after successful deletion
            } else {
                const errorData = await response.json();
                console.error("Error:", errorData.error);
            }
        } catch (error) {
            console.error("Request failed:", error);
        }
    }

    async function startTraining(raceId, raceName, numCars, carNames) {
        console.log("Start Training Clicked!");
        console.log("Race ID:", raceId);
        console.log("Race Name:", raceName);
        console.log("Number of Cars:", numCars);
        console.log("Car Names:", carNames);

        const idToken = localStorage.getItem("id_token");
        if (!idToken) {
            alert("You must be logged in to start training.");
            window.location.href = "/login/";
            return;
        }

        if (!confirm(`Start training for ${numCars} cars in ${raceName}?`)) {
            return;
        }

        try {
            const response = await fetch("/ml_integration/start-training/", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + idToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ 
                    race_id: raceId, 
                    race_name: raceName,
                    num_cars: numCars, 
                    car_names: carNames.split(',') 
                })
            });

            const data = await response.json();
            console.log("Response Data:", data);

            if (response.ok) {
                alert(data.message);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Failed to start training. Please try again.");
        }
    }

</script>
{% endblock %}
